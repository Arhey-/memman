<head>
	<meta content="width=device-width, initial-scale=1" name="viewport">
	<style>
		:root {
			--repeat: auto-fit;
		}
		body {
			display: grid;
			grid-template-columns: repeat(var(--repeat), minmax(320px, 1fr));
		}
		a {
			position: relative;
		}
		a > p {
			color: white;
			background-color: rgba(0,0,0,0.3);
			margin: 5px;
			position: absolute;
		}
		a > img {
			width: 100%;
		}
		#tool {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		}
	</style>
</head>

<div id="tool">
	<button id="end">end</button>
	<input id="perRow" type='number' placeholder='auto-fit' />
	<input id="key" type='text' />
	<button id="show">show</button>
</div>
<script>
	//todo storage event
	const key = 'tempItems';
	const $ = selector => document.querySelector(selector);
	const create = name => document.createElement(name);
	const addCard = i => {
		const a=create('a'), p=create('p'), img=create('img');
		a.href = i.url;
		img.src = i.src;
		p.textContent = i.title;
		a.append(p, img);
		document.body.appendChild(a);
	};
	
	$('#key').placeholder = key;
	$('#show').onclick = () => {
		for (const i of load($('#key').value || key)) {
			addCard(i);
		}
	};
	$('#perRow').onchange = () => document.documentElement.style.setProperty(
		'--repeat',
		$('#perRow').value || 'auto-fit'
	);
	
	let moveToEnd;
	$('#end').onclick = () => moveToEnd = true;
	document.body.addEventListener('click', e => {
		if (!moveToEnd || 'A' != e.target.parentElement.tagName) return;
		e.preventDefault();
		moveToEnd = false;
		const k = $('#key').value || key;
		const items = load(k);
		if (!items.length) return;
		const a = e.target.parentElement;
		const url = a.href;
		const i = items.findIndex(i => i.url == url);
		const [item] = items.splice(i, 1);
		items.push(item);
		save(k, items);
		a.parentElement.append(a);
	});
	
	const log = t => {
		const p = document.createElement('p');
		p.textContent = t;
		document.body.appendChild(p);
	};
	addEventListener('error', log);

	function save(key, o) {
		const s = JSON.stringify(o);
		localStorage.setItem(key, s);
	}

	function load(key) {
		let items = [];
		try {
			items = JSON.parse(localStorage.getItem(key)) || [];
		} catch(e) {
			log(`parsing error ${e}`);
		}
		return items;
	}
	
	addEventListener('message', e => {
		log('message');
		const k = e.data?.key || key;
		let items = load(k);
		const { url, src, title } = e.data;
		//todo already exist
		items.push({ url, src, title });
		const s = JSON.stringify(items);
		localStorage.setItem(k, s);
		log(`saved (${s.length}) ${title}`);
		addCard(e.data);
	});
	opener?.postMessage('ready', '*');
</script>
